<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>NeurWebXR_AR</title>
    <link rel="stylesheet" type="text/css" href="./src/css/style.css">
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v2.1.0/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-arkit@0.2.0/dist/aframe-arkit.min.js"></script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene 
  vr-mode-ui="enabled: false" 
  embedded 
  arjs="sourceType: gps, debugUIEnabled: false; trackingMethod: gps;"
  arkit="detectionMode: plane;">
  
  <!-- 使用 GPS 來生成模型 -->
  <a-entity gps-entity-place="latitude: 25.033964; longitude: 121.564468" id="my-model" gltf-model="#myModel" scale="1 1 1" visible="false">
  </a-entity>

  <!-- 確保相機可以執行 ARKit 的平面偵測 -->
  <a-camera gps-camera rotation-reader arkit-hit-test="target: #my-model;"></a-camera>

  <!-- 確保你的模型在生成時會進行平面偵測並對應地板高度 -->
  <script>
    AFRAME.registerComponent('adjust-height-on-plane', {
      init: function () {
        var model = document.querySelector('#my-model');
        
        this.el.addEventListener('gps-entity-place-update-entity', function () {
          // 在 GPS 座標下顯示模型
          model.setAttribute('visible', 'true');
        });
        
        this.el.addEventListener('hit-test-start', function (event) {
          // 透過平面偵測調整模型的高度
          var intersection = event.detail.intersection;
          if (intersection && model.getAttribute('visible')) {
            var position = model.getAttribute('position');
            position.y = intersection.point.y;  // 調整 y 軸高度至平面
            model.setAttribute('position', position);
          }
        });
      }
    });

    // 啟動組件來監聽事件
    AFRAME.registerComponent('plane-detector', {
      init: function () {
        var sceneEl = this.el;
        sceneEl.addEventListener('loaded', function () {
          sceneEl.camera.el.setAttribute('adjust-height-on-plane', '');
        });
      }
    });
  </script>
  
</a-scene>

  </body>
</html>
